# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–º —Ü–∏–∫–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (–ö–†–ò–¢–ò–ß–ù–û)**
**–°–∏–º–ø—Ç–æ–º**: –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.

**–ü—Ä–∏—á–∏–Ω–∞**: 
- PostgreSQL —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–º–µ—é—Ç timeout –∏ –º–æ–≥—É—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å—Å—è —Å–µ—Ä–≤–µ—Ä–æ–º
- SQLite —Å `check_same_thread=False` –º–æ–∂–µ—Ç –ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_ensure_connection()` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `_reconnect()` –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
- –î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º –≤ `execute_query()` —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∏ exponential backoff
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫: `psycopg2.OperationalError`, `psycopg2.InterfaceError`, `sqlite3.OperationalError`

### 2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è–º–∏ –≤ —Ü–∏–∫–ª–∞—Ö**
**–°–∏–º–ø—Ç–æ–º**: –ï—Å–ª–∏ –≤ `search_cycle()` –∏–ª–∏ `telegram_cycle()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –æ—à–∏–±–∫–∞, –≤–µ—Å—å —Ü–∏–∫–ª –º–æ–∂–µ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞**:
- Schedule –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ –ø–æ—Å–ª–µ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π
- –û—à–∏–±–∫–∏ –≤ `config.reload_if_needed()` –º–æ–≥—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Å—å scheduler loop

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- –î–æ–±–∞–≤–ª–µ–Ω retry –º–µ—Ö–∞–Ω–∏–∑–º (3 –ø–æ–ø—ã—Ç–∫–∏) –≤ `search_cycle()` –∏ `telegram_cycle()`
- Exponential backoff –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (5s, 10s, 15s)
- –¶–∏–∫–ª—ã –Ω–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Ä—É–∂—É - –æ–Ω–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç scheduler
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `config.reload_if_needed()` - –ø—Ä–∏ –æ—à–∏–±–∫–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `schedule.run_pending()` - –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ loop –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è

### 3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å daemon threads –≤ Gunicorn**
**–°–∏–º–ø—Ç–æ–º**: –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ Gunicorn worker, scheduler thread —Ç–µ—Ä—è–µ—Ç—Å—è.

**–ü—Ä–∏—á–∏–Ω–∞**:
- Daemon threads —É–º–∏—Ä–∞—é—Ç –≤–º–µ—Å—Ç–µ —Å –≥–ª–∞–≤–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- Gunicorn –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç workers, —Ç–µ—Ä—è—è scheduler thread

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- –î–æ–±–∞–≤–ª–µ–Ω health check monitor –≤ `wsgi.py`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥: –∂–∏–≤ –ª–∏ scheduler thread
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ scheduler thread –µ—Å–ª–∏ –æ–Ω —É–º–µ—Ä
- Heartbeat –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ scheduler loop

### 4. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º –≤ –ë–î –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö**
**–°–∏–º–ø—Ç–æ–º**: –û—à–∏–±–∫–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∫–∞—Å–∫–∞–¥–Ω—ã–º —Å–±–æ—è–º –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É.

**–ü—Ä–∏—á–∏–Ω–∞**:
- –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∞—Ç—å –≤ –ë–î –æ—à–∏–±–∫—É –æ —Ç–æ–º, —á—Ç–æ –ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–æ–≤–æ–π –æ—à–∏–±–∫–µ
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ
- –í—Å–µ –≤—ã–∑–æ–≤—ã `db.add_log_entry()` –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-except
- –ü—Ä–∏ –æ—à–∏–±–∫–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ë–î, –æ—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Ñ–∞–π–ª/stdout
- –¶–∏–∫–ª—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞–∂–µ –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —É–ª—É—á—à–µ–Ω–∏–π

### Database Layer (db.py)
```
execute_query() 
  ‚Üì
  _ensure_connection() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  ‚Üì
  [–ø–æ–ø—ã—Ç–∫–∞ 1] execute SQL
  ‚Üì (–µ—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è)
  _reconnect() ‚Üí –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  ‚Üì
  [–ø–æ–ø—ã—Ç–∫–∞ 2] execute SQL
  ‚Üì (–µ—Å–ª–∏ —Å–Ω–æ–≤–∞ –æ—à–∏–±–∫–∞)
  [–ø–æ–ø—ã—Ç–∫–∞ 3] execute SQL
  ‚Üì
  return —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ raise exception
```

### Scheduler Loop (mercari_notifications.py)
```
run_scheduler()
  ‚Üì
  while True:
    ‚Üì
    try: config.reload_if_needed()
    except: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    ‚Üì
    try: schedule.run_pending()
      ‚Üì
      search_cycle() ‚Üí retry 3 —Ä–∞–∑–∞ —Å backoff
      telegram_cycle() ‚Üí retry 3 —Ä–∞–∑–∞ —Å backoff
    except: –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
    ‚Üì
    –æ–±–Ω–æ–≤–∏—Ç—å heartbeat –∫–∞–∂–¥—ã–µ 10s
    ‚Üì
    sleep(1)
```

### Health Check (wsgi.py)
```
start_scheduler()
  ‚Üì
  while True:
    ‚Üì
    try: –∑–∞–ø—É—Å—Ç–∏—Ç—å MercariNotificationApp.run_scheduler()
    except: –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å exponential backoff
    
health_check_monitor()
  ‚Üì
  while True:
    ‚Üì
    sleep(60)
    ‚Üì
    –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: scheduler_thread.is_alive()
    ‚Üì
    –µ—Å–ª–∏ –º–µ—Ä—Ç–≤ ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π thread
    ‚Üì
    –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: heartbeat –Ω–µ —Å—Ç–∞—Ä—à–µ 5 –º–∏–Ω—É—Ç
    ‚Üì
    –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
```

## üöÄ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

### db.py
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `_ensure_connection()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `_reconnect()` - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
3. ‚úÖ –£–ª—É—á—à–µ–Ω `execute_query()` - retry –º–µ—Ö–∞–Ω–∏–∑–º —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è PostgreSQL –∏ SQLite

### mercari_notifications.py
1. ‚úÖ –£–ª—É—á—à–µ–Ω `search_cycle()` - retry –º–µ—Ö–∞–Ω–∏–∑–º —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
2. ‚úÖ –£–ª—É—á—à–µ–Ω `telegram_cycle()` - retry –º–µ—Ö–∞–Ω–∏–∑–º —Å 3 –ø–æ–ø—ã—Ç–∫–∞–º–∏
3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `config.reload_if_needed()`
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `schedule.run_pending()`
5. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω heartbeat –º–µ—Ö–∞–Ω–∏–∑–º - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
6. ‚úÖ –í—Å–µ –≤—ã–∑–æ–≤—ã `db.add_log_entry()` –æ–±–µ—Ä–Ω—É—Ç—ã –≤ try-except

### wsgi.py
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `health_check_monitor()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
2. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ scheduler thread –µ—Å–ª–∏ –æ–Ω —É–º–µ—Ä
3. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤ –ë–î
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω `scheduler_health` state –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç 1: –°–∏–º—É–ª—è—Ü–∏—è –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
```python
# –í Python –∫–æ–Ω—Å–æ–ª–∏
from db import get_db
db = get_db()

# –ó–∞–∫—Ä—ã—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
db.conn.close()

# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å
searches = db.get_all_searches()  # –î–æ–ª–∂–Ω–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
print(f"–ü–æ–ª—É—á–µ–Ω–æ {len(searches)} –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤")
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
python mercari_notifications.py

# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# [SCHEDULER] ‚è∞ Loop alive! Iteration X
# [SCHEDULER] Jobs scheduled: Y
# Heartbeat updates –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

# –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—à–∏–±–∫–∞, –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# [SEARCH] Error (attempt 1/3): ...
# [SEARCH] Retrying in 5 seconds...
# [SEARCH] Error (attempt 2/3): ...
# [SEARCH] Retrying in 10 seconds...
```

### –¢–µ—Å—Ç 3: Health Check Monitor
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ wsgi.py (–∫–∞–∫ –Ω–∞ Railway)
gunicorn wsgi:application

# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
# ‚úÖ Background scheduler thread started with auto-restart
# ‚úÖ Health check monitor started
# [HEALTH] Health check monitor started

# –ï—Å–ª–∏ scheduler thread —É–º—Ä–µ—Ç, –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# [HEALTH] ‚ùå Scheduler thread is DEAD! Restarting...
# [HEALTH] ‚úÖ Scheduler thread restarted
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ

**–•–æ—Ä–æ—à–∏–µ –∑–Ω–∞–∫–∏** ‚úÖ:
- `[DB] ‚úÖ Reconnected to PostgreSQL` - —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `[SCHEDULER] ‚è∞ Loop alive!` - scheduler —Ä–∞–±–æ—Ç–∞–µ—Ç
- `[SEARCH] Completed at ...` - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
- `[TELEGRAM] Sent X/Y notifications` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã

**–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è** ‚ö†Ô∏è:
- `[DB] Connection check failed: ..., reconnecting...` - –ø—Ä–æ–±–ª–µ–º—ã —Å –ë–î, –Ω–æ –∏—Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è
- `[CONFIG] ‚ö†Ô∏è Failed to reload config:` - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à
- `[HEALTH] ‚ö†Ô∏è No heartbeat for X seconds` - scheduler loop –º–µ–¥–ª–µ–Ω–Ω—ã–π, –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** ‚ùå:
- `[DB ERROR] ‚ùå Failed to reconnect:` - –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ë–î –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
- `[SEARCH] All retry attempts exhausted` - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫
- `[HEALTH] ‚ùå Scheduler thread is DEAD!` - scheduler thread —É–º–µ—Ä –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

## üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –î–ª—è PostgreSQL –Ω–∞ Railway
```env
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
DATABASE_URL=postgresql://...  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç Railway

# –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=10
DB_POOL_TIMEOUT=30
```

### –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (SQLite)
```env
DATABASE_URL=  # –û—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è SQLite
SQLITE_DB_PATH=mercari_bot.db
```

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. Connection pooling –¥–ª—è PostgreSQL
```python
# –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ psycopg2.connect() –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
from psycopg2 import pool
connection_pool = pool.SimpleConnectionPool(1, 10, DATABASE_URL)
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫
```python
# –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –≤ metrics_storage.py
- db_reconnections_count
- search_cycle_failures
- telegram_cycle_failures
- scheduler_restarts
```

### 3. Alerting –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
```python
# –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ Telegram –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
if retry_count >= max_retries:
    send_system_message(f"‚ö†Ô∏è CRITICAL: Search cycle failed after {max_retries} attempts")
```

## ‚úÖ –†–µ–∑—é–º–µ

### –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
2. ‚úÖ Retry –º–µ—Ö–∞–Ω–∏–∑–º –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ü–∏–∫–ª–∞—Ö
3. ‚úÖ Health check –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ scheduler thread
4. ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ - —Ü–∏–∫–ª—ã –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
5. ‚úÖ Heartbeat –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
6. ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–∞—Å–∫–∞–¥–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤ –ë–î

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
- üöÄ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ 24/7
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ–µ–≤
- üìä –ü–æ–ª–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø—Ä–æ–±–ª–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
- ‚ö° –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–±–æ—è—Ö

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏. –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫ –±–æ—Ç –¥–æ–ª–∂–µ–Ω:
1. –ó–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
2. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
3. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –µ—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2024
**–í–µ—Ä—Å–∏—è**: –ü–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
