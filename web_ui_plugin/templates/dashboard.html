{% extends "base.html" %}

{% block title %}Dashboard - MercariSearcher{% endblock %}

{% block content %}
<h1 class="mb-4">Dashboard</h1>

<div class="row">
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Searches</h5>
                <h2>{{ stats.total_searches }}</h2>
                <small class="text-muted">{{ stats.active_searches }} active</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Total Items</h5>
                <h2 id="total-items">{{ stats.total_items }}</h2>
                <small class="text-muted">{{ stats.unsent_items }} pending</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">API Requests</h5>
                <h2 id="api-requests">{{ total_api_requests }}</h2>
                <small class="text-muted">since start</small>
            </div>
        </div>
    </div>

    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">System Uptime</h5>
                <h2 id="uptime">{{ state_stats.uptime }}</h2>
                <small class="text-muted">hours:minutes:seconds</small>
            </div>
        </div>
    </div>
</div>

<!-- Recent Items Section (Auto-refresh every 30 seconds) -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>Recent Items (Last 24 Hours)
                </h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="window.runSearch()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Force Scan All
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="window.clearAllItems()">
                        <i class="bi bi-trash me-1"></i>Clear All Items
                    </button>
                    <a href="/items" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-grid-3x3 me-1"></i>View All Items
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row" id="recent-items-container">
                    <!-- Items will be loaded here by JavaScript auto-refresh -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading recent items...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load recent items
function loadRecentItems() {
    fetch('/api/recent-items')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to load recent items:', data.error);
                document.getElementById('recent-items-container').innerHTML = 
                    '<div class="col-12 text-center py-3"><p class="text-danger">Failed to load recent items</p></div>';
                return;
            }
            
            const container = document.getElementById('recent-items-container');
            
            if (!data.items || data.items.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-3"><p class="text-muted">No items found yet</p></div>';
                return;
            }
            
            // Render items (same style as items page)
            let html = '';
            data.items.forEach(item => {
                // Use /api/image endpoint to serve images from database
                let imageUrl = item.id ? `/api/image/${item.id}` : '';

                // Calculate USD price
                const usdPrice = (item.price * {{ config.USD_CONVERSION_RATE }}).toFixed(2);

                html += `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                        <div class="card h-100">
                            <a href="${item.item_url}" target="_blank" class="text-decoration-none">
                                <div style="aspect-ratio: 4/5; overflow: hidden; background: #f8f9fa;">
                                    ${imageUrl ?
                                        `<img src="${imageUrl}" class="d-block w-100 h-100" style="object-fit: cover;" loading="lazy"
                                              onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2rem; color: #999;\\'></i><small class=\\'text-muted mt-2\\'>Click to view</small></div>';">` :
                                        `<div class="bg-light d-flex align-items-center justify-content-center h-100 flex-column">
                                            <i class="bi bi-image" style="font-size: 2rem; color: #999;"></i>
                                            <small class="text-muted mt-2">Click to view</small>
                                        </div>`
                                    }
                                </div>
                            </a>
                            <div class="card-body d-flex flex-column p-3">
                                <h6 class="card-title mb-2 fw-bold" style="font-size: 14px; line-height: 1.3;">
                                    ${item.title.substring(0, 60)}${item.title.length > 60 ? '...' : ''}
                                </h6>
                                <div class="mb-2 p-2 bg-light rounded">
                                    <span class="fw-bold text-dark" style="font-size: 18px; display: block;">
                                        $${usdPrice}
                                    </span>
                                    <span class="text-muted" style="font-size: 13px;">
                                        ¥${item.price}${item.size ? ' · ' + item.size : ''}
                                    </span>
                                </div>
                                ${item.search_keyword ? 
                                    `<div class="mb-2">
                                        <span class="badge bg-primary" style="font-size: 11px;">${item.search_keyword}</span>
                                    </div>` : ''
                                }
                                ${item.found_at ? 
                                    `<small class="text-muted mt-auto" style="font-size: 11px;">${item.found_at}</small>` : ''
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading recent items:', error);
            document.getElementById('recent-items-container').innerHTML = 
                '<div class="col-12 text-center py-3"><p class="text-danger">Error loading items</p></div>';
        });
}

// Force scan all queries
window.runSearch = function() {
    if (!confirm('Start scanning all queries now?')) return;
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scanning...';
    
    fetch('/api/force-scan', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('✅ Scan started! Check logs for results.');
                setTimeout(() => loadRecentItems(), 3000);
            } else {
                alert('❌ Failed: ' + data.error);
            }
        })
        .catch(err => alert('❌ Error: ' + err))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Force Scan All';
        });
};

// Clear all items
window.clearAllItems = function() {
    if (!confirm('⚠️ Delete ALL items from database? This cannot be undone!\n\nA new scan will start automatically after clearing.')) return;
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Clearing...';
    
    fetch('/api/clear-all-items', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(`✅ ${data.message}`);
                setTimeout(() => loadRecentItems(), 3000);
            } else {
                alert('❌ Failed: ' + data.error);
            }
        })
        .catch(err => alert('❌ Error: ' + err))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash me-1"></i>Clear All Items';
        });
};

// Auto-refresh stats and items
function refreshStats() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-items').textContent = data.database.total_items;
                document.getElementById('api-requests').textContent = data.total_api_requests;
                document.getElementById('uptime').textContent = data.uptime_formatted;
            }
        })
        .catch(err => console.error('Stats refresh failed:', err));
}

// Initial load
loadRecentItems();

// Auto-refresh every 30 seconds
setInterval(() => {
    loadRecentItems();
    refreshStats();
}, 30000);

// Refresh stats every 5 seconds
setInterval(refreshStats, 5000);
</script>
{% endblock %}
