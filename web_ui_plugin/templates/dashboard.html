{% extends "base.html" %}

{% block title %}Dashboard - MRS{% endblock %}

{% block content %}
<h1 class="mb-3 d-none d-md-block">Dashboard</h1>

<!-- Mobile-optimized stats (single row with 4 columns) -->
<div class="row g-2 mb-3">
    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Searches</div>
                <div class="fw-bold" style="font-size: 1.2rem;">{{ stats.total_searches }}</div>
                <div class="small text-success" style="font-size: 0.65rem;">{{ stats.active_searches }} active</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Items</div>
                <div class="fw-bold" style="font-size: 1.2rem;" id="total-items">{{ stats.total_items }}</div>
                <div class="small text-warning" style="font-size: 0.65rem;">{{ stats.unsent_items }} new</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">API</div>
                <div class="fw-bold" style="font-size: 1.2rem;" id="api-requests">{{ total_api_requests }}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">requests</div>
            </div>
        </div>
    </div>

    <div class="col-3">
        <div class="card h-100">
            <div class="card-body p-2 text-center">
                <div class="small text-muted mb-1" style="font-size: 0.7rem;">Uptime</div>
                <div class="fw-bold" style="font-size: 0.9rem;" id="uptime">{{ state_stats.uptime }}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">h:m:s</div>
            </div>
        </div>
    </div>
</div>

<!-- Compact Action Buttons (Mobile-optimized) -->
<div class="row g-2 mb-3">
    <div class="col-4">
        <button class="btn btn-success btn-sm w-100" onclick="window.runSearch()" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-arrow-clockwise"></i><span class="d-none d-sm-inline ms-1">Scan</span>
        </button>
    </div>
    <div class="col-4">
        <button class="btn btn-danger btn-sm w-100" onclick="window.clearAllItems()" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-trash"></i><span class="d-none d-sm-inline ms-1">Clear</span>
        </button>
    </div>
    <div class="col-4">
        <a href="/items" class="btn btn-outline-primary btn-sm w-100" style="font-size: 0.75rem; padding: 0.4rem;">
            <i class="bi bi-grid-3x3"></i><span class="d-none d-sm-inline ms-1">All</span>
        </a>
    </div>
</div>

<!-- Recent Items Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0 d-flex align-items-center" style="font-size: 0.9rem;">
                    <i class="bi bi-clock-history me-2"></i>Recent Items (24h)
                </h6>
            </div>
            <div class="card-body">
                <div class="row" id="recent-items-container">
                    <!-- Items will be loaded here by JavaScript auto-refresh -->
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading recent items...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Infinite scroll state
let currentOffset = 0;
let isLoading = false;
let hasMore = true;
const itemsPerPage = 30;

// Clean timestamp function (remove microseconds)
function cleanTimestamp(ts) {
    if (!ts || typeof ts !== 'string') return ts;
    // Remove microseconds (e.g., "2025-11-19 22:43:32.585535" -> "2025-11-19 22:43:32")
    if (ts.includes('.')) {
        const parts = ts.split('.');
        if (parts.length === 2) {
            // Check if there's timezone info after microseconds
            if (parts[1].includes(' ')) {
                const tzPart = parts[1].split(' ').slice(1).join(' ');
                return tzPart ? `${parts[0]} ${tzPart}` : parts[0];
            }
            return parts[0];
        }
    }
    return ts;
}

// Format relative time (e.g., "5 minutes ago")
function timeAgo(timestamp) {
    if (!timestamp) return '';
    
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) return 'только что';
    if (diffMin < 60) return `${diffMin} мин. назад`;
    if (diffHour < 24) return `${diffHour} ч. назад`;
    if (diffDay < 7) return `${diffDay} дн. назад`;
    
    return cleanTimestamp(timestamp);
}

// Load recent items
function loadRecentItems(append = false) {
    if (isLoading || (!hasMore && append)) return;

    isLoading = true;

    if (!append) {
        currentOffset = 0;
        hasMore = true;
    }

    fetch(`/api/recent-items?limit=${itemsPerPage}&offset=${currentOffset}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Failed to load recent items:', data.error);
                document.getElementById('recent-items-container').innerHTML = 
                    '<div class="col-12 text-center py-3"><p class="text-danger">Failed to load recent items</p></div>';
                return;
            }
            
            const container = document.getElementById('recent-items-container');

            if (!data.items || data.items.length === 0) {
                if (!append) {
                    container.innerHTML = '<div class="col-12 text-center py-3"><p class="text-muted">No items found yet</p></div>';
                }
                hasMore = false;
                isLoading = false;
                return;
            }

            // Check if there are more items
            if (data.items.length < itemsPerPage) {
                hasMore = false;
            }

            // Render items (same style as items page)
            let html = '';
            data.items.forEach(item => {
                // Use direct image URL from Mercari CDN (fast!)
                const imageUrl = item.image_url || '';

                // Calculate USD price (fallback to 0.0067 if not set)
                const usdRate = {{ config.USD_CONVERSION_RATE }} || 0.0067;
                const usdPrice = (item.price * usdRate).toFixed(2);
                
                // Truncate title to 6 words
                const titleWords = item.title.split(' ');
                const shortTitle = titleWords.slice(0, 6).join(' ') + (titleWords.length > 6 ? '...' : '');

                html += `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-2 mb-3" data-item-id="${item.id}">
                        <div class="card h-100 shadow-sm">
                            <a href="${item.item_url}" target="_blank" class="text-decoration-none">
                                <div class="item-image-container" style="aspect-ratio: 4/5; overflow: hidden; background: var(--bg-card); border-radius: 0.25rem 0.25rem 0 0;">
                                    ${imageUrl ?
                                        `<img src="${imageUrl}" class="d-block w-100 h-100" style="object-fit: cover;" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"
                                              onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2.5rem; color: #ccc;\\'></i><small class=\\'text-muted mt-2\\'>Tap to view</small></div>';">` :
                                        `<div class="bg-light d-flex align-items-center justify-content-center h-100 flex-column">
                                            <i class="bi bi-image" style="font-size: 2.5rem; color: #ccc;"></i>
                                            <small class="text-muted mt-2">Tap to view</small>
                                        </div>`
                                    }
                                </div>
                            </a>
                            <div class="card-body p-2 d-flex flex-column" style="min-height: 125px;">
                                <h6 class="card-title mb-2 fw-bold text-truncate" style="font-size: 0.8rem; line-height: 1.25; max-height: 2.5rem; overflow: hidden; word-wrap: break-word;">
                                    ${shortTitle}
                                </h6>
                                <div class="mt-auto">
                                    <div class="mb-2" style="min-height: 42px;">
                                        <div class="fw-bold" style="font-size: 1.1rem; line-height: 1.2;">$${usdPrice}</div>
                                        <div class="text-muted" style="font-size: 0.7rem; line-height: 1.2;">¥${item.price}</div>
                                    </div>
                                    <div class="d-flex flex-column gap-1">
                                        ${item.search_keyword ?
                                            `<span class="badge bg-primary align-self-start" style="font-size: 0.6rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${item.search_keyword.substring(0, 15)}</span>` : ''
                                        }
                                        ${item.found_at ?
                                            `<small class="text-muted time-ago" style="font-size: 0.65rem;" data-timestamp="${item.found_at}">${timeAgo(item.found_at)}</small>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (append) {
                container.insertAdjacentHTML('beforeend', html);
                currentOffset += data.items.length;
            } else {
                container.innerHTML = html;
                currentOffset = data.items.length;
            }

            isLoading = false;
        })
        .catch(error => {
            console.error('Error loading recent items:', error);
            if (!append) {
                document.getElementById('recent-items-container').innerHTML =
                    '<div class="col-12 text-center py-3"><p class="text-danger">Error loading items</p></div>';
            }
            isLoading = false;
        });
}

// Infinite scroll detector
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        if (isLoading || !hasMore) return;

        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        // Load more when user is 300px from bottom
        if (scrollPosition >= pageHeight - 300) {
            loadRecentItems(true);
        }
    });
}

// Force scan all queries
window.runSearch = function() {
    if (!confirm('Start scanning all queries now?')) return;
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scanning...';
    
    fetch('/api/force-scan', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('✅ Scan started! Check logs for results.');
                setTimeout(() => loadRecentItems(), 3000);
            } else {
                alert('❌ Failed: ' + data.error);
            }
        })
        .catch(err => alert('❌ Error: ' + err))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i>Force Scan All';
        });
};

// Clear all items
window.clearAllItems = function() {
    if (!confirm('⚠️ Delete ALL items from database? This cannot be undone!\n\nA new scan will start automatically after clearing.')) return;
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Clearing...';
    
    fetch('/api/clear-all-items', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(`✅ ${data.message}`);
                setTimeout(() => loadRecentItems(), 3000);
            } else {
                alert('❌ Failed: ' + data.error);
            }
        })
        .catch(err => alert('❌ Error: ' + err))
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-trash me-1"></i>Clear All Items';
        });
};

// Auto-refresh stats and items
function refreshStats() {
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-items').textContent = data.database.total_items;
                document.getElementById('api-requests').textContent = data.total_api_requests;
                document.getElementById('uptime').textContent = data.uptime_formatted;
            }
        })
        .catch(err => console.error('Stats refresh failed:', err));
}

// Update time ago labels
function updateTimeAgo() {
    document.querySelectorAll('.time-ago').forEach(el => {
        const timestamp = el.getAttribute('data-timestamp');
        if (timestamp) {
            el.textContent = timeAgo(timestamp);
        }
    });
}

// Refresh only NEW items (prepend new items to top)
function refreshNewItems() {
    fetch('/api/recent-items?limit=10&offset=0')
        .then(r => r.json())
        .then(data => {
            if (!data.success || !data.items || data.items.length === 0) return;
            
            const container = document.getElementById('recent-items-container');
            const existingIds = new Set();
            container.querySelectorAll('[data-item-id]').forEach(el => {
                existingIds.add(el.getAttribute('data-item-id'));
            });
            
            // Only add NEW items that don't exist yet
            const newItems = data.items.filter(item => !existingIds.has(String(item.id)));
            if (newItems.length === 0) return;
            
            const usdRate = {{ config.USD_CONVERSION_RATE }} || 0.0067;
            let html = '';
            
            newItems.forEach(item => {
                const imageUrl = item.image_url || '';
                const usdPrice = (item.price * usdRate).toFixed(2);
                const titleWords = item.title.split(' ');
                const shortTitle = titleWords.slice(0, 6).join(' ') + (titleWords.length > 6 ? '...' : '');
                
                html += `
                    <div class="col-6 col-sm-4 col-md-3 col-lg-3 col-xl-2 mb-3" data-item-id="${item.id}">
                        <div class="card h-100 shadow-sm">
                            <a href="${item.item_url}" target="_blank" class="text-decoration-none">
                                <div class="item-image-container" style="aspect-ratio: 4/5; overflow: hidden; background: var(--bg-card); border-radius: 0.25rem 0.25rem 0 0;">
                                    ${imageUrl ?
                                        `<img src="${imageUrl}" class="d-block w-100 h-100" style="object-fit: cover;" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"
                                              onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2.5rem; color: #ccc;\\'></i><small class=\\'text-muted mt-2\\'>Tap to view</small></div>';">` :
                                        `<div class="bg-light d-flex align-items-center justify-content-center h-100 flex-column">
                                            <i class="bi bi-image" style="font-size: 2.5rem; color: #ccc;"></i>
                                            <small class="text-muted mt-2">Tap to view</small>
                                        </div>`
                                    }
                                </div>
                            </a>
                            <div class="card-body p-2 d-flex flex-column" style="min-height: 125px;">
                                <h6 class="card-title mb-2 fw-bold text-truncate" style="font-size: 0.8rem; line-height: 1.25; max-height: 2.5rem; overflow: hidden; word-wrap: break-word;">
                                    ${shortTitle}
                                </h6>
                                <div class="mt-auto">
                                    <div class="mb-2" style="min-height: 42px;">
                                        <div class="fw-bold" style="font-size: 1.1rem; line-height: 1.2;">$${usdPrice}</div>
                                        <div class="text-muted" style="font-size: 0.7rem; line-height: 1.2;">¥${item.price}</div>
                                    </div>
                                    <div class="d-flex flex-column gap-1">
                                        ${item.search_keyword ?
                                            `<span class="badge bg-primary align-self-start" style="font-size: 0.6rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">${item.search_keyword.substring(0, 15)}</span>` : ''
                                        }
                                        ${item.found_at ?
                                            `<small class="text-muted time-ago" style="font-size: 0.65rem;" data-timestamp="${item.found_at}">${timeAgo(item.found_at)}</small>` : ''
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Prepend new items to top
            container.insertAdjacentHTML('afterbegin', html);
            currentOffset += newItems.length;
        })
        .catch(err => console.error('Error refreshing new items:', err));
}

// Initial load
loadRecentItems();
setupInfiniteScroll();

// Auto-refresh every 20 seconds
setInterval(() => {
    refreshStats();
    updateTimeAgo(); // Update relative timestamps
    // refreshNewItems() disabled - causes items to lose data
    // Users can manually refresh page to see new items
}, 20000);
</script>
{% endblock %}
