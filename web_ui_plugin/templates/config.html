{% extends "base.html" %}

{% block title %}Configuration - MercariSearcher{% endblock %}

{% block content %}
<h1 class="mb-4">Configuration</h1>

<!-- System Settings -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-gear"></i> System Settings</h5>
    </div>
    <div class="card-body">
        <form id="systemSettingsForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Items Per Query</label>
                    <input type="number" class="form-control" name="max_items_per_search"
                           value="{{ config.MAX_ITEMS_PER_SEARCH }}" min="1" max="120">
                    <small class="text-muted">How many items to scan per query</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Query Delay (seconds)</label>
                    <input type="number" class="form-control" name="search_interval"
                           value="{{ config.SEARCH_INTERVAL }}" min="60" max="3600">
                    <small class="text-muted">Global delay between all queries</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">JPY to USD Rate</label>
                    <input type="number" step="0.0001" class="form-control" name="usd_conversion_rate"
                           value="{{ config.USD_CONVERSION_RATE }}" min="0.0001" max="1">
                    <small class="text-muted">Current: 159¥ ≈ 1$ (0.0063)</small>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                <i class="bi bi-save"></i> Save System Settings
            </button>
        </form>
    </div>
</div>

<!-- Telegram Bot Settings -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-telegram"></i> Telegram Bot</h5>
        <span class="badge bg-{{ 'success' if config.TELEGRAM_BOT_TOKEN else 'secondary' }}">
            {{ 'Running' if config.TELEGRAM_BOT_TOKEN else 'Not Configured' }}
        </span>
    </div>
    <div class="card-body">
        <form id="telegramSettingsForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Bot Token</label>
                    <input type="text" class="form-control" name="telegram_bot_token"
                           value="{{ config.TELEGRAM_BOT_TOKEN or '' }}"
                           placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <small class="text-muted">Get this from <a href="https://t.me/BotFather" target="_blank">@BotFather</a></small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Chat ID</label>
                    <input type="text" class="form-control" name="telegram_chat_id"
                           value="{{ config.TELEGRAM_CHAT_ID or '' }}"
                           placeholder="-1001234567890">
                    <small class="text-muted">The chat ID where notifications will be sent</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveTelegramSettings()">
                    <i class="bi bi-save"></i> Save Telegram Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="testTelegramBot()">
                    <i class="bi bi-send"></i> Send Test Message
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Proxy Settings -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-shield"></i> Proxy System Status</h5>
        <span class="badge bg-{{ 'success' if config.PROXY_ENABLED else 'secondary' }}">
            {{ 'Enabled' if config.PROXY_ENABLED else 'Disabled' }}
        </span>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>Status:</strong> <span id="proxy-status">{{ 'Active' if config.PROXY_ENABLED else 'Inactive' }}</span>
            </div>
            <div class="col-md-4">
                <strong>Total Proxies:</strong> <span id="proxy-total">{{ config.PROXY_LIST|length }}</span>
            </div>
            <div class="col-md-4">
                <strong>Current Proxy:</strong> <code class="small" id="proxy-current">{{ config.PROXY_LIST[0] if config.PROXY_LIST else 'None' }}</code>
            </div>
        </div>

        <form id="proxySettingsForm">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="proxy_enabled"
                           id="proxyEnabled" {{ 'checked' if config.PROXY_ENABLED else '' }}>
                    <label class="form-check-label" for="proxyEnabled">
                        Enable Proxy (Bot can work without proxy)
                    </label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Proxy List (one per line)</label>
                <textarea class="form-control" name="proxy_list" rows="5"
                          placeholder="http://user:pass@host:port&#10;socks5://host:port">{{ config.PROXY_LIST|join('\n') if config.PROXY_LIST else '' }}</textarea>
                <small class="text-muted">Format: protocol://user:pass@host:port</small>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveProxySettings()">
                    <i class="bi bi-save"></i> Save Proxy Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="testProxies()">
                    <i class="bi bi-check-circle"></i> Test Proxies
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Railway Auto-Redeploy System -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Railway Auto-Redeploy System</h5>
        <span class="badge bg-info" id="redeploy-status">Active</span>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-3">
                <strong>HTTP Errors:</strong>
                <div class="mt-2">
                    <span class="badge bg-danger">403: <span id="error-403">0</span></span>
                    <span class="badge bg-warning">401: <span id="error-401">0</span></span>
                    <span class="badge bg-info">429: <span id="error-429">0</span></span>
                </div>
            </div>
            <div class="col-md-3">
                <strong>Total Errors:</strong> <span id="total-errors" class="text-danger">0</span><br>
                <small class="text-muted">Threshold: {{ config.MAX_ERRORS_BEFORE_REDEPLOY }}</small>
            </div>
            <div class="col-md-3">
                <strong>First Error:</strong> <span id="first-error" class="small">None</span>
            </div>
            <div class="col-md-3">
                <strong>Last Redeploy:</strong> <span id="last-redeploy" class="small">Never</span>
            </div>
        </div>

        <form id="railwaySettingsForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Redeploy Threshold</label>
                    <input type="number" class="form-control" name="max_errors_before_redeploy"
                           value="{{ config.MAX_ERRORS_BEFORE_REDEPLOY }}" min="1" max="100">
                    <small class="text-muted">Number of errors before triggering redeploy</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Railway Token</label>
                    <input type="password" class="form-control" name="railway_token"
                           value="{{ config.RAILWAY_TOKEN or '' }}"
                           placeholder="Optional - for auto-redeploy">
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveRailwaySettings()">
                    <i class="bi bi-save"></i> Save Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="refreshRailwayStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="forceRedeploy()">
                    <i class="bi bi-exclamation-triangle"></i> Force Redeploy
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Read-only Info -->
