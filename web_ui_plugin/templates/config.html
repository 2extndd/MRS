{% extends "base.html" %}

{% block title %}Configuration - MRS{% endblock %}

{% block content %}
<h1 class="mb-4">Configuration</h1>

<!-- Theme Settings (Mobile-optimized) -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-palette"></i> Theme Settings</h5>
    </div>
    <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
            <div>
                <strong class="d-block mb-1">Appearance</strong>
                <small class="text-muted">Choose your preferred color theme. Your choice is saved automatically.</small>
            </div>
            <button class="theme-toggle-btn" onclick="toggleTheme()" id="themeToggleBtn">
                <i class="bi bi-moon-fill"></i>
                <span class="theme-text d-none d-sm-inline">Dark Mode</span>
            </button>
        </div>
    </div>
</div>

<!-- System Settings -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-gear"></i> System Settings</h5>
    </div>
    <div class="card-body">
        <form id="systemSettingsForm">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Items Per Query</label>
                    <input type="number" class="form-control" name="max_items_per_search"
                           value="{{ config.MAX_ITEMS_PER_SEARCH }}" min="1" max="120">
                    <small class="text-muted">How many items to scan per query</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Query Delay (seconds)</label>
                    <input type="number" class="form-control" name="search_interval"
                           value="{{ config.SEARCH_INTERVAL }}" min="60" max="3600">
                    <small class="text-muted">How often to scan all queries</small>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">JPY to USD Rate</label>
                    <input type="number" step="0.0001" class="form-control" name="usd_conversion_rate"
                           value="{{ config.USD_CONVERSION_RATE }}" min="0.0001" max="1">
                    <small class="text-muted">Current: 159¬• ‚âà 1$ (0.0063)</small>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                <i class="bi bi-save"></i> Save System Settings
            </button>
        </form>
    </div>
</div>

<!-- Category Blacklist (Global Filter) -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-funnel"></i> Category Filter</h5>
    </div>
    <div class="card-body">
        <form id="categoryBlacklistForm">
            <div class="mb-3">
                <label class="form-label">Blacklisted Categories (one per line)</label>
                <textarea class="form-control" name="category_blacklist" rows="6" id="categoryBlacklistInput"
                          placeholder="„Ç≤„Éº„É†„Éª„Åä„ÇÇ„Å°„ÇÉ„Éª„Ç∞„ÉÉ„Ç∫&#10;Êú¨„ÉªÈü≥Ê•Ω„Éª„Ç≤„Éº„É†&#10;„Ç®„É≥„Çø„É°„Éª„Éõ„Éì„Éº">{{ config.CATEGORY_BLACKLIST|join('\n') if config.CATEGORY_BLACKLIST else '' }}</textarea>
                <small class="text-muted">Items from these categories will be automatically filtered out and won't appear in Telegram. Enter category names in Japanese as they appear on Mercari.</small>
            </div>
            <div class="alert alert-info mb-3">
                <strong>‚ÑπÔ∏è How it works:</strong> Any item whose category contains one of the blacklisted strings will be rejected before being saved to the database. This is a <strong>global filter</strong> that applies to all search queries.
            </div>
            <div class="mb-3">
                <strong>Common categories to filter:</strong>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCategoryToBlacklist('„Ç≤„Éº„É†„Éª„Åä„ÇÇ„Å°„ÇÉ„Éª„Ç∞„ÉÉ„Ç∫')">
                        üéÆ Games & Toys
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCategoryToBlacklist('Êú¨„ÉªÈü≥Ê•Ω„Éª„Ç≤„Éº„É†')">
                        üìö Books & Music
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCategoryToBlacklist('„Ç®„É≥„Çø„É°„Éª„Éõ„Éì„Éº')">
                        üé™ Entertainment
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addCategoryToBlacklist('„Éô„Éì„Éº„Éª„Ç≠„ÉÉ„Ç∫')">
                        üë∂ Baby & Kids
                    </button>
                </div>
            </div>
            <button type="button" class="btn btn-primary" onclick="saveCategoryBlacklist()">
                <i class="bi bi-save"></i> Save Category Filter
            </button>
        </form>
    </div>
</div>

<!-- Telegram Bot Settings -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-telegram"></i> Telegram Bot</h5>
        <span class="badge bg-{{ 'success' if config.TELEGRAM_BOT_TOKEN else 'secondary' }}">
            {{ 'Running' if config.TELEGRAM_BOT_TOKEN else 'Not Configured' }}
        </span>
    </div>
    <div class="card-body">
        <form id="telegramSettingsForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Bot Token</label>
                    <input type="text" class="form-control" name="telegram_bot_token"
                           value="{{ config.TELEGRAM_BOT_TOKEN or '' }}"
                           placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <small class="text-muted">Get this from <a href="https://t.me/BotFather" target="_blank">@BotFather</a></small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Chat ID</label>
                    <input type="text" class="form-control" name="telegram_chat_id"
                           value="{{ config.TELEGRAM_CHAT_ID or '' }}"
                           placeholder="-1001234567890">
                    <small class="text-muted">The chat ID where notifications will be sent</small>
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveTelegramSettings()">
                    <i class="bi bi-save"></i> Save Telegram Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="testTelegramBot()">
                    <i class="bi bi-send"></i> Send Test Message
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Proxy Settings -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-shield"></i> Proxy System Status</h5>
        <span class="badge bg-{{ 'success' if config.PROXY_ENABLED else 'secondary' }}">
            {{ 'Enabled' if config.PROXY_ENABLED else 'Disabled' }}
        </span>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-4">
                <strong>Status:</strong> <span id="proxy-status">{{ 'Active' if config.PROXY_ENABLED else 'Inactive' }}</span>
            </div>
            <div class="col-md-4">
                <strong>Total Proxies:</strong> <span id="proxy-total">{% if config.PROXY_LIST is string %}{{ config.PROXY_LIST.split('\n')|select|list|length }}{% else %}{{ config.PROXY_LIST|length }}{% endif %}</span>
            </div>
            <div class="col-md-4">
                <strong>Current Proxy:</strong> <code class="small" id="proxy-current">{% if config.PROXY_LIST %}{% if config.PROXY_LIST is string %}{{ config.PROXY_LIST.split('\n')[0] }}{% else %}{{ config.PROXY_LIST[0] }}{% endif %}{% else %}None{% endif %}</code>
            </div>
        </div>

        <form id="proxySettingsForm">
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="proxy_enabled"
                           id="proxyEnabled" {{ 'checked' if config.PROXY_ENABLED else '' }}>
                    <label class="form-check-label" for="proxyEnabled">
                        Enable Proxy (Bot can work without proxy)
                    </label>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Proxy List (one per line)</label>
                <textarea class="form-control" name="proxy_list" rows="5"
                          placeholder="http://user:pass@host:port&#10;socks5://host:port">{% if config.PROXY_LIST is string %}{{ config.PROXY_LIST }}{% elif config.PROXY_LIST %}{{ config.PROXY_LIST|join('\n') }}{% endif %}</textarea>
                <small class="text-muted">Format: protocol://user:pass@host:port</small>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveProxySettings()">
                    <i class="bi bi-save"></i> Save Proxy Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="testProxies()">
                    <i class="bi bi-check-circle"></i> Test Proxies
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Railway Auto-Redeploy System -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Railway Auto-Redeploy System</h5>
        <span class="badge bg-info" id="redeploy-status">Active</span>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-3">
                <strong>HTTP Errors:</strong>
                <div class="mt-2">
                    <span class="badge bg-danger">403: <span id="error-403">0</span></span>
                    <span class="badge bg-warning">401: <span id="error-401">0</span></span>
                    <span class="badge bg-info">429: <span id="error-429">0</span></span>
                </div>
            </div>
            <div class="col-md-3">
                <strong>Total Errors:</strong> <span id="total-errors" class="text-danger">0</span><br>
                <small class="text-muted">Threshold: {{ config.MAX_ERRORS_BEFORE_REDEPLOY }}</small>
            </div>
            <div class="col-md-3">
                <strong>First Error:</strong> <span id="first-error" class="small">None</span>
            </div>
            <div class="col-md-3">
                <strong>Last Redeploy:</strong> <span id="last-redeploy" class="small">Never</span>
            </div>
        </div>

        <form id="railwaySettingsForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Redeploy Threshold</label>
                    <input type="number" class="form-control" name="max_errors_before_redeploy"
                           value="{{ config.MAX_ERRORS_BEFORE_REDEPLOY }}" min="1" max="100">
                    <small class="text-muted">Number of errors before triggering redeploy</small>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Railway Token</label>
                    <input type="password" class="form-control" name="railway_token"
                           value="{{ config.RAILWAY_TOKEN or '' }}"
                           placeholder="Optional - for auto-redeploy">
                </div>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" onclick="saveRailwaySettings()">
                    <i class="bi bi-save"></i> Save Settings
                </button>
                <button type="button" class="btn btn-outline-info" onclick="refreshRailwayStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
                <button type="button" class="btn btn-outline-danger" onclick="forceRedeploy()">
                    <i class="bi bi-exclamation-triangle"></i> Force Redeploy
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Read-only Info -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-info-circle"></i> System Information</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <strong>App Name:</strong> {{ config.APP_NAME }}<br>
                <strong>Version:</strong> {{ config.APP_VERSION }}
            </div>
            <div class="col-md-4">
                <strong>Mercari URL:</strong> <code>{{ config.MERCARI_BASE_URL }}</code>
            </div>
            <div class="col-md-4">
                <strong>Display Currency:</strong> {{ config.DISPLAY_CURRENCY }}<br>
                <strong>Port:</strong> {{ config.PORT }}
            </div>
        </div>
    </div>
</div>

<!-- Database Statistics -->
<div class="card mb-4">
    <div class="card-header">
        <h5><i class="bi bi-database"></i> Database Statistics</h5>
    </div>
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-md-3">
                <strong>Total Items:</strong> <span id="db-total-items" class="badge bg-primary">Loading...</span>
            </div>
            <div class="col-md-3">
                <strong>Items with Category:</strong> <span id="db-items-with-category" class="badge bg-success">-</span>
            </div>
            <div class="col-md-3">
                <strong>Items without Category:</strong> <span id="db-items-without-category" class="badge bg-warning">-</span>
            </div>
            <div class="col-md-3">
                <strong>Active Searches:</strong> <span id="db-active-searches" class="badge bg-info">-</span>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <h6 class="mb-2">Item Type Breakdown:</h6>
            </div>
            <div class="col-md-6">
                <strong>SHOPS Items:</strong> <span id="db-shops-items" class="badge bg-secondary">-</span>
                <small class="text-muted d-block mt-1">
                    With category: <span id="db-shops-with-cat">-</span> |
                    Without: <span id="db-shops-without-cat">-</span>
                </small>
            </div>
            <div class="col-md-6">
                <strong>Regular Items:</strong> <span id="db-regular-items" class="badge bg-secondary">-</span>
                <small class="text-muted d-block mt-1">
                    With category: <span id="db-regular-with-cat">-</span> |
                    Without: <span id="db-regular-without-cat">-</span>
                </small>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <h6 class="mb-2">Last 2 Days Statistics:</h6>
            </div>
            <div class="col-md-4">
                <strong>Total (2 days):</strong> <span id="db-2d-total" class="badge bg-info">-</span>
            </div>
            <div class="col-md-4">
                <strong>With Category:</strong> <span id="db-2d-with-cat" class="badge bg-success">-</span>
            </div>
            <div class="col-md-4">
                <strong>Without Category:</strong> <span id="db-2d-without-cat" class="badge bg-warning">-</span>
            </div>
        </div>

        <div class="mt-3">
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshDatabaseStats()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Stats
            </button>
        </div>
    </div>
</div>

<script>
// Save system settings
function saveSystemSettings() {
    const form = document.getElementById('systemSettingsForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/config/system', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ System settings saved!\n' + (data.note || ''));
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Save Telegram settings
function saveTelegramSettings() {
    const form = document.getElementById('telegramSettingsForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/config/telegram', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Telegram settings saved!');
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Test Telegram bot
function testTelegramBot() {
    fetch('/api/notifications/test', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Test message sent to Telegram!');
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Save proxy settings
function saveProxySettings() {
    const form = document.getElementById('proxySettingsForm');
    const formData = new FormData(form);
    const data = {
        proxy_enabled: form.proxyEnabled.checked,
        proxy_list: formData.get('proxy_list')
    };
    
    fetch('/api/config/proxy', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Proxy settings saved!');
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Test proxies
function testProxies() {
    alert('‚è≥ Testing proxies... This may take a minute.');
    fetch('/api/proxy/test', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Proxy test completed!\n\nWorking: ${data.working}/${data.total}\n${data.message}`);
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Save Railway settings
function saveRailwaySettings() {
    const form = document.getElementById('railwaySettingsForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/config/railway', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Railway settings saved!');
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Refresh Railway status
function refreshRailwayStatus() {
    fetch('/api/railway/status')
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const status = data.status;
            document.getElementById('error-403').textContent = status.errors['403'];
            document.getElementById('error-401').textContent = status.errors['401'];
            document.getElementById('error-429').textContent = status.errors['429'];
            document.getElementById('total-errors').textContent = status.total_errors;
            document.getElementById('first-error').textContent = status.first_error;
            document.getElementById('last-redeploy').textContent = status.last_redeploy;
            document.getElementById('redeploy-status').textContent = status.status;
            document.getElementById('redeploy-status').className = 'badge bg-' + 
                (status.status === 'active' ? 'success' : status.status === 'warning' ? 'warning' : 'danger');
        }
    });
}

// Force redeploy
function forceRedeploy() {
    if (!confirm('‚ö†Ô∏è Are you sure you want to force redeploy?\n\nThis will restart the Railway service.')) {
        return;
    }
    
    alert('‚è≥ Triggering redeploy...');
    fetch('/api/railway/redeploy', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Redeploy triggered successfully!');
            refreshRailwayStatus();
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    });
}

// Auto-refresh Railway status every 30 seconds
setInterval(refreshRailwayStatus, 30000);
refreshRailwayStatus();

// Category Blacklist functions
function addCategoryToBlacklist(category) {
    const textarea = document.getElementById('categoryBlacklistInput');
    const currentValue = textarea.value.trim();
    
    // Check if category already exists
    const lines = currentValue.split('\n').map(l => l.trim()).filter(l => l);
    if (lines.includes(category)) {
        alert('‚ö†Ô∏è This category is already in the blacklist!');
        return;
    }
    
    // Add category
    if (currentValue) {
        textarea.value = currentValue + '\n' + category;
    } else {
        textarea.value = category;
    }
    
    // Highlight the textarea briefly
    textarea.style.borderColor = '#0d6efd';
    setTimeout(() => { textarea.style.borderColor = ''; }, 1000);
}

function saveCategoryBlacklist() {
    const textarea = document.getElementById('categoryBlacklistInput');
    const categoriesText = textarea.value.trim();
    
    // Parse categories (one per line)
    const categories = categoriesText
        .split('\n')
        .map(c => c.trim())
        .filter(c => c.length > 0);
    
    console.log('[CONFIG] Saving category blacklist:', categories);
    
    fetch('/api/config/system', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            category_blacklist: categories  // Send as array, backend will serialize
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Category filter saved!\n\n' + categories.length + ' categories will be filtered.\n\nFilters will apply automatically within 10 seconds.');
        } else {
            alert('‚ùå Failed to save: ' + data.error);
        }
    })
    .catch(err => {
        alert('‚ùå Error: ' + err);
    });
}

// Initialize theme toggle button state
function initThemeToggle() {
    const currentTheme = window.getCurrentTheme();
    const icon = document.querySelector('.theme-toggle-btn i');
    const text = document.querySelector('.theme-toggle-btn .theme-text');

    if (icon) {
        icon.className = currentTheme === 'dark' ? 'bi bi-sun-fill' : 'bi bi-moon-fill';
    }
    if (text) {
        text.textContent = currentTheme === 'dark' ? 'Light Mode' : 'Dark Mode';
    }
}

// Refresh database statistics
function refreshDatabaseStats() {
    // Fetch basic stats
    fetch('/api/stats')
        .then(r => r.json())
        .then(data => {
            if (data.success && data.database) {
                document.getElementById('db-total-items').textContent = data.database.total_items || 0;
                document.getElementById('db-active-searches').textContent = data.database.active_searches || 0;
            }
        })
        .catch(err => console.error('Failed to fetch basic stats:', err));

    // Fetch category stats
    fetch('/api/category-stats')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const allTime = data.all_time;
                const last2Days = data.last_2_days;

                // All time stats
                document.getElementById('db-items-with-category').textContent = allTime.items_with_category || 0;
                document.getElementById('db-items-without-category').textContent = allTime.items_without_category || 0;

                // SHOPS items
                document.getElementById('db-shops-items').textContent = allTime.shops_items || 0;
                document.getElementById('db-shops-with-cat').textContent = allTime.shops_with_category || 0;
                document.getElementById('db-shops-without-cat').textContent = allTime.shops_without_category || 0;

                // Regular items
                document.getElementById('db-regular-items').textContent = allTime.regular_items || 0;
                document.getElementById('db-regular-with-cat').textContent = allTime.regular_with_category || 0;
                document.getElementById('db-regular-without-cat').textContent = allTime.regular_without_category || 0;

                // Last 2 days
                document.getElementById('db-2d-total').textContent = last2Days.total_items || 0;
                document.getElementById('db-2d-with-cat').textContent = last2Days.items_with_category || 0;
                document.getElementById('db-2d-without-cat').textContent = last2Days.items_without_category || 0;
            }
        })
        .catch(err => {
            console.error('Failed to fetch category stats:', err);
            document.getElementById('db-total-items').textContent = 'Error';
        });
}

// Initialize on page load
initThemeToggle();
refreshDatabaseStats();
</script>
{% endblock %}
