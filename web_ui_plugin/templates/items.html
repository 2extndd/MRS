{% extends "base.html" %}

{% block title %}Items - MercariSearcher{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-box me-2"></i>Items
            </h1>
        </div>
    </div>
</div>

<!-- Items Grid - with infinite scroll -->
<div class="row" id="items-grid-container">
    {% if items %}
        {% for item in items %}
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
            <div class="card h-100">
                <!-- Clickable Image with 4:5 aspect ratio - OPENS MERCARI -->
                <a href="{{ item.item_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none position-relative d-block">
                    {% if item.image_url %}
                        <div style="aspect-ratio: 4/5; overflow: hidden; position: relative; background: #f8f9fa;">
                            <img src="{{ item.image_url }}"
                                 class="d-block w-100 h-100"
                                 alt="{{ item.title }}"
                                 style="object-fit: cover; object-position: center;"
                                 loading="lazy"
                                 referrerpolicy="no-referrer"
                                 crossorigin="anonymous"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 flex-column\'><i class=\'bi bi-image\' style=\'font-size: 2rem; color: #999;\'></i><small class=\'text-muted mt-2\'>Click to view</small></div>';">
                        </div>
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center flex-column"
                             style="aspect-ratio: 4/5;">
                            <i class="bi bi-image" style="font-size: 2rem; color: #999;"></i>
                            <small class="text-muted mt-2">Click to view</small>
                        </div>
                    {% endif %}
                </a>
                
                <div class="card-body d-flex flex-column p-3">
                    <!-- Title -->
                    <h6 class="card-title mb-2 fw-bold" style="font-size: 14px; line-height: 1.3;">
                        {{ item.title[:60] }}{% if item.title|length > 60 %}...{% endif %}
                    </h6>
                    
                    <!-- Price with Size - BIGGER & MORE VISIBLE -->
                    <div class="mb-2 p-2 bg-light rounded">
                        <span class="fw-bold text-dark" style="font-size: 18px; display: block;">
                            ${{ (item.price * (config.USD_CONVERSION_RATE or 0.0067))|round(2) }}
                        </span>
                        <span class="text-muted" style="font-size: 13px;">
                            ¥{{ item.price }}{% if item.size %} · {{ item.size }}{% endif %}
                        </span>
                    </div>
                    
                    <!-- Search Query Badge -->
                    {% if item.search_keyword %}
                    <div class="mb-2">
                        <span class="badge bg-primary" style="font-size: 11px; font-weight: 500;">
                            {{ item.search_keyword }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Found timestamp -->
                    {% if item.found_at %}
                    <small class="text-muted mt-auto" style="font-size: 11px;">
                        {{ item.found_at|clean_timestamp }}
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12 text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-2">No items found yet</p>
        </div>
    {% endif %}
</div>

<!-- Loading indicator -->
<div class="row mt-4" id="loading-indicator" style="display: none;">
    <div class="col-12 text-center py-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading more...</span>
        </div>
        <p class="text-muted mt-2 small">Loading more items...</p>
    </div>
</div>

<script>
// Infinite scroll state
let currentOffset = {{ items|length if items else 0 }};
let isLoading = false;
let hasMore = true;
const itemsPerPage = 30;
const usdRate = {{ config.USD_CONVERSION_RATE }} || 0.0067;

// Clean timestamp function (remove microseconds)
function cleanTimestamp(ts) {
    if (!ts || typeof ts !== 'string') return ts;
    // Remove microseconds (e.g., "2025-11-19 22:43:32.585535" -> "2025-11-19 22:43:32")
    if (ts.includes('.')) {
        const parts = ts.split('.');
        if (parts.length === 2) {
            // Check if there's timezone info after microseconds
            if (parts[1].includes(' ')) {
                const tzPart = parts[1].split(' ').slice(1).join(' ');
                return tzPart ? `${parts[0]} ${tzPart}` : parts[0];
            }
            return parts[0];
        }
    }
    return ts;
}

// Load more items
function loadMoreItems() {
    if (isLoading || !hasMore) return;

    isLoading = true;
    document.getElementById('loading-indicator').style.display = 'block';

    fetch(`/api/items?limit=${itemsPerPage}&offset=${currentOffset}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success || !data.items || data.items.length === 0) {
                hasMore = false;
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            // Check if there are more items
            if (data.items.length < itemsPerPage) {
                hasMore = false;
            }

            // Render new items
            const container = document.getElementById('items-grid-container');
            data.items.forEach(item => {
                const usdPrice = (item.price * usdRate).toFixed(2);
                const imageUrl = item.image_url || '';

                const html = `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                        <div class="card h-100">
                            <a href="${item.item_url}" target="_blank" rel="noopener noreferrer" class="text-decoration-none position-relative d-block">
                                ${imageUrl ?
                                    `<div style="aspect-ratio: 4/5; overflow: hidden; position: relative; background: #f8f9fa;">
                                        <img src="${imageUrl}" class="d-block w-100 h-100" style="object-fit: cover;" loading="lazy"
                                             referrerpolicy="no-referrer" crossorigin="anonymous"
                                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2rem; color: #999;\\'></i><small class=\\'text-muted mt-2\\'>Click</small></div>';">
                                    </div>` :
                                    `<div class="bg-light d-flex align-items-center justify-content-center flex-column" style="aspect-ratio: 4/5;">
                                        <i class="bi bi-image" style="font-size: 2rem; color: #999;"></i>
                                        <small class="text-muted mt-2">Click to view</small>
                                    </div>`
                                }
                            </a>
                            <div class="card-body d-flex flex-column p-3">
                                <h6 class="card-title mb-2 fw-bold" style="font-size: 14px; line-height: 1.3;">
                                    ${item.title.substring(0, 60)}${item.title.length > 60 ? '...' : ''}
                                </h6>
                                <div class="mb-2 p-2 bg-light rounded">
                                    <span class="fw-bold text-dark" style="font-size: 18px; display: block;">$${usdPrice}</span>
                                    <span class="text-muted" style="font-size: 13px;">¥${item.price}${item.size ? ' · ' + item.size : ''}</span>
                                </div>
                                ${item.search_keyword ? `<div class="mb-2"><span class="badge bg-primary" style="font-size: 11px;">${item.search_keyword}</span></div>` : ''}
                                ${item.found_at ? `<small class="text-muted mt-auto" style="font-size: 11px;">${cleanTimestamp(item.found_at)}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
            });

            currentOffset += data.items.length;
            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        })
        .catch(err => {
            console.error('Error loading more items:', err);
            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        });
}

// Infinite scroll detector
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        if (isLoading || !hasMore) return;

        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        // Load more when user is 300px from bottom
        if (scrollPosition >= pageHeight - 300) {
            loadMoreItems();
        }
    });
}

// Initial setup
document.addEventListener('DOMContentLoaded', function() {
    setupInfiniteScroll();
});
</script>
{% endblock %}
