{% extends "base.html" %}

{% block title %}Items - MRS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-box me-2"></i>Items
            </h1>
        </div>
    </div>
</div>

<!-- Search Filter - Compact -->
<div class="row mb-3">
    <div class="col-12">
        <div class="input-group">
            <input type="text" class="form-control" id="searchInput" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (—Ä–∞–∑–¥–µ–ª—è–π—Ç–µ —á–µ—Ä–µ–∑ ;)" 
                   oninput="filterItems()">
            <button class="btn btn-outline-secondary" onclick="clearSearch()" title="–û—á–∏—Å—Ç–∏—Ç—å">
                <i class="bi bi-x-circle"></i>
            </button>
            <button class="btn btn-primary" onclick="filterItems()" title="–ù–∞–π—Ç–∏">
                <i class="bi bi-search"></i>
            </button>
        </div>
        <small class="text-muted" id="items-count">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤: {{ items|length if items else 0 }}</small>
    </div>
</div>

<!-- Items Grid - with infinite scroll -->
<div class="row" id="items-grid-container">
    {% if items %}
        {% for item in items %}
        <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
            <div class="card h-100 position-relative item-card" data-category="{{ item.category if item.category else '' }}">
                <!-- Small blacklist button (appears on hover, for ALL items with category) -->
                {% if item.category %}
                <button class="btn btn-sm btn-danger position-absolute blacklist-btn"
                        style="top: 5px; right: 5px; z-index: 10; opacity: 0; transition: opacity 0.2s; padding: 2px 6px; font-size: 10px;"
                        onclick="addCategoryToBlacklist('{{ item.category }}'); event.stopPropagation();"
                        title="Block category: {{ item.category }}">
                    üö´
                </button>
                {% endif %}

                <!-- Clickable Image with 4:5 aspect ratio - OPENS MERCARI -->
                <a href="{{ item.item_url }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none position-relative d-block">
                    {% if item.image_url %}
                        <div style="aspect-ratio: 4/5; overflow: hidden; position: relative; background: #f8f9fa;">
                            {# Use proxy for ALL Mercari images to bypass CORS/hotlink protection #}
                            <img src="{{ url_for('get_item_image', item_id=item.id) }}"
                                 class="d-block w-100 h-100"
                                 alt="{{ item.title }}"
                                 style="object-fit: cover; object-position: center;"
                                 loading="lazy"
                                 onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 flex-column\'><i class=\'bi bi-image\' style=\'font-size: 2rem; color: #999;\'></i><small class=\'text-muted mt-2\'>Click to view</small></div>';">
                        </div>
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center flex-column"
                             style="aspect-ratio: 4/5;">
                            <i class="bi bi-image" style="font-size: 2rem; color: #999;"></i>
                            <small class="text-muted mt-2">Click to view</small>
                        </div>
                    {% endif %}
                </a>
                
                <div class="card-body d-flex flex-column p-3" style="min-height: 200px;">
                    <!-- Title -->
                    <h6 class="card-title mb-2 fw-bold text-truncate" style="font-size: 14px; line-height: 1.3; max-height: 2.6rem; overflow: hidden; word-wrap: break-word;">
                        {% set words = item.title.split(' ') %}
                        {{ words[:6]|join(' ') }}{% if words|length > 6 %}...{% endif %}
                    </h6>
                    
                    <!-- Price with Size - BIGGER & MORE VISIBLE -->
                    <div class="mt-auto p-2 bg-light rounded" style="min-height: 50px;">
                        <span class="fw-bold text-dark" style="font-size: 18px; display: block;">
                            ${{ (item.price * (config.USD_CONVERSION_RATE or 0.0067))|round(2) }}
                        </span>
                        <span class="text-muted" style="font-size: 13px;">
                            ¬•{{ item.price }}{% if item.size %} - <strong>{{ item.size }}</strong>{% endif %}
                        </span>
                    </div>
                    
                    <!-- Search Query Badge -->
                    {% if item.search_keyword %}
                    <div class="mb-2">
                        <span class="badge bg-primary" style="font-size: 11px; font-weight: 500;">
                            {{ item.search_keyword }}
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- Found timestamp -->
                    {% if item.found_at %}
                    <small class="text-muted mt-auto time-ago" style="font-size: 11px;" data-timestamp="{{ item.found_at }}">
                        {{ item.found_at|clean_timestamp }}
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12 text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-2">No items found yet</p>
        </div>
    {% endif %}
</div>

<!-- Loading indicator -->
<div class="row mt-4" id="loading-indicator" style="display: none;">
    <div class="col-12 text-center py-3">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading more...</span>
        </div>
        <p class="text-muted mt-2 small">Loading more items...</p>
    </div>
</div>

<script>
// Infinite scroll state
let currentOffset = {{ items|length if items else 0 }};
let isLoading = false;
let hasMore = true;
const itemsPerPage = 30;
const usdRate = {{ config.USD_CONVERSION_RATE }} || 0.0067;

// Clean timestamp function (remove microseconds)
function cleanTimestamp(ts) {
    if (!ts || typeof ts !== 'string') return ts;
    // Remove microseconds (e.g., "2025-11-19 22:43:32.585535" -> "2025-11-19 22:43:32")
    if (ts.includes('.')) {
        const parts = ts.split('.');
        if (parts.length === 2) {
            // Check if there's timezone info after microseconds
            if (parts[1].includes(' ')) {
                const tzPart = parts[1].split(' ').slice(1).join(' ');
                return tzPart ? `${parts[0]} ${tzPart}` : parts[0];
            }
            return parts[0];
        }
    }
    return ts;
}

// Format relative time (e.g., "5 minutes ago")
function timeAgo(timestamp) {
    if (!timestamp) return '';
    
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffMin < 60) return `${diffMin} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    if (diffHour < 24) return `${diffHour} —á. –Ω–∞–∑–∞–¥`;
    if (diffDay < 7) return `${diffDay} –¥–Ω. –Ω–∞–∑–∞–¥`;
    
    return cleanTimestamp(timestamp);
}

// Filter items by multiple search terms (separated by semicolon)
function filterItems() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const searchTerms = searchValue.split(';').map(term => term.trim()).filter(term => term.length > 0);
    
    const items = document.querySelectorAll('#items-grid-container > div');
    let visibleCount = 0;
    
    items.forEach(item => {
        const title = item.querySelector('.card-title')?.textContent.toLowerCase() || '';
        
        if (searchTerms.length === 0) {
            // No search terms - show all
            item.style.display = '';
            visibleCount++;
        } else {
            // Check if title matches ANY search term
            const matches = searchTerms.some(term => title.includes(term));
            item.style.display = matches ? '' : 'none';
            if (matches) visibleCount++;
        }
    });
    
    // Update count display (if exists)
    const countDisplay = document.getElementById('items-count');
    if (countDisplay) {
        countDisplay.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ: ${visibleCount} –∏–∑ ${items.length}`;
    }
}

// Clear search
function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterItems();
}

// Load more items
function loadMoreItems() {
    if (isLoading || !hasMore) return;

    isLoading = true;
    document.getElementById('loading-indicator').style.display = 'block';

    fetch(`/api/items?limit=${itemsPerPage}&offset=${currentOffset}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success || !data.items || data.items.length === 0) {
                hasMore = false;
                document.getElementById('loading-indicator').style.display = 'none';
                return;
            }

            // Check if there are more items
            if (data.items.length < itemsPerPage) {
                hasMore = false;
            }

            // Render new items
            const container = document.getElementById('items-grid-container');
            data.items.forEach(item => {
                const usdPrice = (item.price * usdRate).toFixed(2);
                const imageUrl = item.image_url || '';
                // Use proxy for ALL images (including Mercari Shops)
                const proxiedImageUrl = `/api/image/${item.id}`;

                const html = `
                    <div class="col-lg-2 col-md-3 col-sm-4 col-6 mb-4">
                        <div class="card h-100">
                            <a href="${item.item_url}" target="_blank" rel="noopener noreferrer" class="text-decoration-none position-relative d-block">
                                ${proxiedImageUrl ?
                                    `<div style="aspect-ratio: 4/5; overflow: hidden; position: relative; background: #f8f9fa;">
                                        <img src="${proxiedImageUrl}" class="d-block w-100 h-100" style="object-fit: cover; object-position: center;" loading="lazy"
                                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.innerHTML='<div class=\\'d-flex align-items-center justify-content-center h-100 flex-column\\'><i class=\\'bi bi-image\\' style=\\'font-size: 2rem; color: #999;\\'></i><small class=\\'text-muted mt-2\\'>Click</small></div>';">
                                    </div>` :
                                    `<div class="bg-light d-flex align-items-center justify-content-center flex-column" style="aspect-ratio: 4/5;">
                                        <i class="bi bi-image" style="font-size: 2rem; color: #999;"></i>
                                        <small class="text-muted mt-2">Click to view</small>
                                    </div>`
                                }
                            </a>
                            <div class="card-body d-flex flex-column p-3" style="min-height: 200px;">
                                <h6 class="card-title mb-2 fw-bold text-truncate" style="font-size: 14px; line-height: 1.3; max-height: 2.6rem; overflow: hidden; word-wrap: break-word;">
                                    ${item.title.split(' ').slice(0, 6).join(' ')}${item.title.split(' ').length > 6 ? '...' : ''}
                                </h6>
                                <div class="mt-auto p-2 bg-light rounded" style="min-height: 50px;">
                                    <span class="fw-bold text-dark" style="font-size: 18px; display: block;">$${usdPrice}</span>
                                    <span class="text-muted" style="font-size: 13px;">¬•${item.price}${item.size ? ' - <strong>' + item.size + '</strong>' : ''}</span>
                                </div>
                                ${item.search_keyword ? `<div class="mb-2"><span class="badge bg-primary" style="font-size: 11px;">${item.search_keyword}</span></div>` : ''}
                                ${item.found_at ? `<small class="text-muted mt-auto time-ago" style="font-size: 11px;" data-timestamp="${item.found_at}">${timeAgo(item.found_at)}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', html);
            });

            currentOffset += data.items.length;
            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        })
        .catch(err => {
            console.error('Error loading more items:', err);
            isLoading = false;
            document.getElementById('loading-indicator').style.display = 'none';
        });
}

// Infinite scroll detector
function setupInfiniteScroll() {
    window.addEventListener('scroll', () => {
        if (isLoading || !hasMore) return;

        const scrollPosition = window.innerHeight + window.scrollY;
        const pageHeight = document.documentElement.scrollHeight;

        // Load more when user is 300px from bottom
        if (scrollPosition >= pageHeight - 300) {
            loadMoreItems();
        }
    });
}

// Update time ago labels
function updateTimeAgo() {
    document.querySelectorAll('.time-ago').forEach(el => {
        const timestamp = el.getAttribute('data-timestamp');
        if (timestamp) {
            el.textContent = timeAgo(timestamp);
        }
    });
}

// Add category to blacklist
function addCategoryToBlacklist(category) {
    // Extract root category (before first ' > ')
    // Example: "„Éï„É©„ÉØ„Éº„Éª„Ç¨„Éº„Éá„Éã„É≥„Ç∞ > ÂúíËä∏Áî®ÂìÅ > Èâ¢„Éª„Éó„É©„É≥„Çø„Éº" ‚Üí "„Éï„É©„ÉØ„Éº„Éª„Ç¨„Éº„Éá„Éã„É≥„Ç∞"
    const rootCategory = category.split(' > ')[0].trim();
    
    if (!confirm(`Add ROOT category "${rootCategory}" to blacklist?\n\nFull path: ${category}\n\nAll items from this category will be filtered out.`)) {
        return;
    }

    fetch('/api/config/category_blacklist/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ category: rootCategory })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (data.already_exists) {
                alert(`‚ÑπÔ∏è Category "${rootCategory}" was already in blacklist!`);
            } else {
                alert(`‚úÖ Category "${rootCategory}" added to blacklist!\n\nTotal categories: ${data.total_categories}`);
            }
            // Hide all items with this root category
            document.querySelectorAll('.item-card').forEach(card => {
                const itemCategory = card.getAttribute('data-category');
                if (itemCategory && itemCategory.startsWith(rootCategory)) {
                    card.parentElement.style.display = 'none';
                }
            });
        } else {
            alert(`‚ùå Failed to add category: ${data.error || 'Unknown error'}`);
        }
    })
    .catch(err => {
        console.error('Error adding category to blacklist:', err);
        alert('‚ùå Error adding category to blacklist');
    });
}

// Initial setup
document.addEventListener('DOMContentLoaded', function() {
    setupInfiniteScroll();
    updateTimeAgo(); // Initialize time ago on load

    // Update time ago every 20 seconds
    setInterval(updateTimeAgo, 20000);
});
</script>

<style>
/* Show blacklist button on hover */
.item-card:hover .blacklist-btn {
    opacity: 1 !important;
}
</style>
{% endblock %}
