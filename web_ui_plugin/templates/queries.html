{% extends "base.html" %}

{% block title %}Queries - MercariSearcher{% endblock %}

{% block content %}
<h1 class="mb-4">Search Queries</h1>

<button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addQueryModal">
    <i class="bi bi-plus-circle"></i> Add Query
</button>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>#</th>
                <th>Query</th>
                <th>Thread ID</th>
                <th>Last Found Item</th>
                <th>Items</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for search in searches %}
            <tr>
                <td>{{ search.id }}</td>
                <td>
                    <a href="{{ search.search_url }}" target="_blank" class="text-decoration-none">
                        {{ search.name or search.keyword or 'Unnamed Query' }}
                    </a>
                </td>
                <td>
                    <code class="small">{{ search.thread_id or '-' }}</code>
                </td>
                <td>
                    {% if search.last_scanned_at %}
                        <small class="text-muted">{{ search.last_scanned_at }}</small>
                    {% else %}
                        <small class="text-muted">Never</small>
                    {% endif %}
                </td>
                <td>
                    <span class="badge bg-info">{{ search.items_found }}</span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="/items?search_id={{ search.id }}" class="btn btn-sm btn-outline-primary" title="View Items">
                            <i class="bi bi-grid"></i>
                        </a>
                        <button class="btn btn-sm btn-outline-warning" onclick="editQuery({{ search.id }})" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuery({{ search.id }})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    No queries yet. Click "Add Query" to get started!
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if searches %}
<div class="mt-3">
    <button class="btn btn-sm btn-outline-danger" onclick="deleteAllQueries()">
        <i class="bi bi-trash"></i> Remove All Queries
    </button>
</div>
{% endif %}

<!-- Add Query Modal -->
<div class="modal fade" id="addQueryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Search Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQueryForm">
                    <div class="mb-3">
                        <label class="form-label">Mercari Search URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="search_url" required
                               placeholder="https://jp.mercari.com/search?keyword=...">
                        <small class="text-muted">Paste full Mercari search URL from your browser</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name (optional)</label>
                        <input type="text" class="form-control" name="name"
                               placeholder="e.g., Y-3 Sneakers">
                        <small class="text-muted">Give this search a friendly name</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thread ID (optional)</label>
                        <input type="text" class="form-control" name="thread_id"
                               placeholder="e.g., 123456">
                        <small class="text-muted">Telegram topic/thread ID for notifications</small>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Items Per Query</strong> and <strong>Scan Interval</strong> are configured globally in 
                        <a href="/config" class="alert-link">Config page</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addQuery()">Add Query</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Query Modal -->
<div class="modal fade" id="editQueryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editQueryForm">
                    <input type="hidden" id="edit_query_id">
                    <div class="mb-3">
                        <label class="form-label">Mercari Search URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_search_url" required>
                        <small class="text-muted">Update the Mercari search URL</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name (optional)</label>
                        <input type="text" class="form-control" id="edit_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Thread ID (optional)</label>
                        <input type="text" class="form-control" id="edit_thread_id">
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Items Per Query</strong> and <strong>Scan Interval</strong> are configured globally in 
                        <a href="/config" class="alert-link">Config page</a>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateQuery()">Update Query</button>
            </div>
        </div>
    </div>
</div>

<script>
function addQuery() {
    const form = document.getElementById('addQueryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    fetch('/api/queries/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.showAlert('Query added successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            window.showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        window.showAlert('Network error: ' + err.message, 'danger');
    });
}

function editQuery(id) {
    fetch(`/api/queries/${id}`)
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            document.getElementById('edit_query_id').value = id;
            document.getElementById('edit_search_url').value = data.query.search_url;
            document.getElementById('edit_name').value = data.query.name || '';
            document.getElementById('edit_thread_id').value = data.query.thread_id || '';
            document.getElementById('edit_scan_limit').value = data.query.scan_limit || 6;
            document.getElementById('edit_scan_interval').value = data.query.scan_interval || 60;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editQueryModal'));
            modal.show();
        } else {
            window.showAlert('Error loading query: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        window.showAlert('Network error: ' + err.message, 'danger');
    });
}

function updateQuery() {
    const id = document.getElementById('edit_query_id').value;
    const data = {
        search_url: document.getElementById('edit_search_url').value,
        name: document.getElementById('edit_name').value,
        thread_id: document.getElementById('edit_thread_id').value,
        scan_limit: parseInt(document.getElementById('edit_scan_limit').value),
        scan_interval: parseInt(document.getElementById('edit_scan_interval').value)
    };

    fetch(`/api/queries/${id}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.showAlert('Query updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            window.showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(err => {
        window.showAlert('Network error: ' + err.message, 'danger');
    });
}

function deleteQuery(id) {
    if (confirm('Are you sure you want to delete this query? This action cannot be undone.')) {
        fetch(`/api/queries/${id}/delete`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.showAlert('Query deleted!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                window.showAlert('Error: ' + data.error, 'danger');
            }
        });
    }
}

function deleteAllQueries() {
    if (confirm('⚠️ Delete ALL queries? This action cannot be undone!')) {
        if (confirm('Are you absolutely sure? This will delete all search queries.')) {
            window.showAlert('Delete all functionality coming soon!', 'warning');
        }
    }
}
</script>
{% endblock %}
