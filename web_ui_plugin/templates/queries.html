{% extends "base.html" %}

{% block title %}Queries - MRS{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-search me-2"></i>Search Queries
            </h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQueryModal">
                <i class="bi bi-plus-circle me-1"></i>Add Query
            </button>
        </div>
    </div>
</div>

<!-- Queries Grid -->
<div class="row" id="queries-container">
    {% if searches %}
        {% for search in searches %}
        <div class="col-lg-4 col-md-6 mb-4" data-query-id="{{ search.id }}">
            <div class="card h-100 shadow-sm hover-shadow">
                <div class="card-body">
                    <!-- Header with name and status -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1 fw-bold">
                                {{ search.name or search.keyword or 'Unnamed Query' }}
                            </h5>
                            <small class="text-muted">
                                <i class="bi bi-key me-1"></i>{{ search.keyword or 'No keyword' }}
                            </small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   {% if search.is_active %}checked{% endif %}
                                   onchange="toggleQuery({{ search.id }})"
                                   title="Enable/Disable">
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <div class="stats-box p-2 bg-primary bg-opacity-10 rounded text-center">
                                <div class="fs-4 fw-bold text-primary">{{ search.items_found or 0 }}</div>
                                <small class="text-muted">Items Found</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stats-box p-2 bg-info bg-opacity-10 rounded text-center">
                                <div class="fs-4 fw-bold text-info">{{ search.total_scans or 0 }}</div>
                                <small class="text-muted">Total Scans</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Info -->
                    <div class="mb-3">
                        {% if search.min_price or search.max_price %}
                        <span class="badge bg-success me-1 mb-1">
                            <i class="bi bi-currency-yen"></i> 
                            {% if search.min_price %}{{ search.min_price }}{% else %}0{% endif %} - 
                            {% if search.max_price %}{{ search.max_price }}{% else %}∞{% endif %}
                        </span>
                        {% endif %}
                        {% if search.condition %}
                        <span class="badge bg-warning text-dark me-1 mb-1">
                            <i class="bi bi-star"></i> {{ search.condition }}
                        </span>
                        {% endif %}
                        {% if search.size %}
                        <span class="badge bg-secondary me-1 mb-1">
                            <i class="bi bi-rulers"></i> {{ search.size }}
                        </span>
                        {% endif %}
                        {% if search.brand %}
                        <span class="badge bg-dark me-1 mb-1">
                            <i class="bi bi-tag"></i> {{ search.brand }}
                        </span>
                        {% endif %}
                    </div>

                    <!-- Scan Settings -->
                    <div class="small text-muted mb-3">
                        <div><i class="bi bi-clock me-1"></i>Interval: {{ search.scan_interval or 300 }}s</div>
                        <div><i class="bi bi-hash me-1"></i>Limit: {{ search.scan_limit or 50 }} items</div>
                        {% if search.thread_id %}
                        <div><i class="bi bi-chat-dots me-1"></i>Thread: {{ search.thread_id }}</div>
                        {% endif %}
                    </div>

                    <!-- Last Scanned -->
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Last scan: 
                            {% if search.last_scanned_at %}
                                <span class="time-ago" data-timestamp="{{ search.last_scanned_at }}">
                                    {{ search.last_scanned_at|clean_timestamp }}
                                </span>
                            {% else %}
                                Never
                            {% endif %}
                        </small>
                    </div>

                    <!-- Actions -->
                    <div class="d-flex gap-2">
                        <a href="{{ search.search_url }}" target="_blank" class="btn btn-sm btn-outline-primary flex-fill" title="Open URL">
                            <i class="bi bi-link-45deg"></i> URL
                        </a>
                        <button class="btn btn-sm btn-outline-warning flex-fill" onclick="editQuery({{ search.id }})" title="Edit">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteQuery({{ search.id }})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-inbox" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">No queries yet</h4>
                <p class="text-muted mb-4">Create your first search query to start monitoring items</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQueryModal">
                    <i class="bi bi-plus-circle me-1"></i>Add Your First Query
                </button>
            </div>
        </div>
    {% endif %}
</div>

<!-- Add Query Modal -->
<div class="modal fade" id="addQueryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Add Search Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQueryForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Search URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="search_url" id="add_search_url" required
                               placeholder="https://jp.mercari.com/search?keyword=...">
                        <small class="text-muted">Paste the full search URL from marketplace</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Query Name</label>
                            <input type="text" class="form-control" name="name" id="add_name"
                                   placeholder="e.g., Nike Sneakers">
                            <small class="text-muted">Friendly name for this search</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Thread ID (optional)</label>
                            <input type="text" class="form-control" name="thread_id" id="add_thread_id"
                                   placeholder="e.g., 123456">
                            <small class="text-muted">Telegram topic ID for notifications</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Scan Interval (seconds)</label>
                            <input type="number" class="form-control" name="scan_interval" id="add_scan_interval" 
                                   value="300" min="60">
                            <small class="text-muted">How often to check for new items</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Items Per Scan</label>
                            <input type="number" class="form-control" name="scan_limit" id="add_scan_limit" 
                                   value="50" min="10" max="100">
                            <small class="text-muted">Max items to fetch per scan</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Tip:</strong> Use marketplace filters in the URL to narrow down your search 
                        (price range, condition, brand, size, etc.)
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addQuery()">
                    <i class="bi bi-plus-circle me-1"></i>Add Query
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Query Modal -->
<div class="modal fade" id="editQueryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit Search Query</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editQueryForm">
                    <input type="hidden" id="edit_query_id">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Search URL <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="search_url" id="edit_search_url" required>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Query Name</label>
                            <input type="text" class="form-control" name="name" id="edit_name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Thread ID</label>
                            <input type="text" class="form-control" name="thread_id" id="edit_thread_id">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Scan Interval (seconds)</label>
                            <input type="number" class="form-control" name="scan_interval" id="edit_scan_interval" min="60">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Items Per Scan</label>
                            <input type="number" class="form-control" name="scan_limit" id="edit_scan_limit" min="10" max="100">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateQuery()">
                    <i class="bi bi-check-circle me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Format relative time
function timeAgo(timestamp) {
    if (!timestamp) return '';
    
    const now = new Date();
    const then = new Date(timestamp);
    const diffMs = now - then;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffSec < 60) return 'только что';
    if (diffMin < 60) return `${diffMin} мин. назад`;
    if (diffHour < 24) return `${diffHour} ч. назад`;
    if (diffDay < 7) return `${diffDay} дн. назад`;
    
    return timestamp;
}

// Update time ago labels
function updateTimeAgo() {
    document.querySelectorAll('.time-ago').forEach(el => {
        const timestamp = el.getAttribute('data-timestamp');
        if (timestamp) {
            el.textContent = timeAgo(timestamp);
        }
    });
}

// Add Query
function addQuery() {
    const form = document.getElementById('addQueryForm');
    const formData = new FormData(form);
    
    const data = {
        search_url: formData.get('search_url'),
        name: formData.get('name'),
        thread_id: formData.get('thread_id'),
        scan_interval: parseInt(formData.get('scan_interval')) || 300,
        scan_limit: parseInt(formData.get('scan_limit')) || 50
    };
    
    fetch('/api/queries/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✅ Query added successfully!');
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(err => alert('❌ Error: ' + err));
}

// Edit Query
function editQuery(queryId) {
    fetch(`/api/queries/${queryId}`)
        .then(r => {
            if (!r.ok) {
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            return r.json();
        })
        .then(data => {
            if (data.success && data.query) {
                const query = data.query;
                
                // Safely set values with null checks
                const editQueryIdEl = document.getElementById('edit_query_id');
                const editSearchUrlEl = document.getElementById('edit_search_url');
                const editNameEl = document.getElementById('edit_name');
                const editThreadIdEl = document.getElementById('edit_thread_id');
                const editScanIntervalEl = document.getElementById('edit_scan_interval');
                const editScanLimitEl = document.getElementById('edit_scan_limit');
                
                if (!editQueryIdEl || !editSearchUrlEl || !editNameEl || !editThreadIdEl || !editScanIntervalEl || !editScanLimitEl) {
                    console.error('Edit form elements not found!');
                    alert('❌ Error: Edit form not properly loaded');
                    return;
                }
                
                editQueryIdEl.value = query.id || '';
                editSearchUrlEl.value = query.search_url || '';
                editNameEl.value = query.name || '';
                editThreadIdEl.value = query.thread_id || '';
                editScanIntervalEl.value = query.scan_interval || 300;
                editScanLimitEl.value = query.scan_limit || 50;
                
                // Show modal
                const modalEl = document.getElementById('editQueryModal');
                if (modalEl) {
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } else {
                    console.error('Edit modal not found!');
                    alert('❌ Error: Edit modal not found');
                }
            } else {
                console.error('API response:', data);
                alert('❌ Error loading query: ' + (data.error || 'Query not found'));
            }
        })
        .catch(err => {
            console.error('Edit query error:', err);
            alert('❌ Network error: ' + err.message);
        });
}

// Update Query
function updateQuery() {
    const queryId = document.getElementById('edit_query_id').value;
    const form = document.getElementById('editQueryForm');
    const formData = new FormData(form);
    
    const data = {
        search_url: formData.get('search_url'),
        name: formData.get('name'),
        thread_id: formData.get('thread_id'),
        scan_interval: parseInt(formData.get('scan_interval')) || 300,
        scan_limit: parseInt(formData.get('scan_limit')) || 50
    };
    
    fetch(`/api/queries/${queryId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('✅ Query updated successfully!');
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
        }
    })
    .catch(err => alert('❌ Error: ' + err));
}

// Toggle Query Active Status
function toggleQuery(queryId) {
    fetch(`/api/queries/${queryId}/toggle`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                console.log(`Query ${queryId} toggled: ${data.is_active}`);
            } else {
                alert('❌ Error: ' + data.error);
                location.reload();
            }
        })
        .catch(err => {
            alert('❌ Error: ' + err);
            location.reload();
        });
}

// Delete Query
function deleteQuery(queryId) {
    if (!confirm('Are you sure you want to delete this query?')) return;
    
    fetch(`/api/queries/${queryId}/delete`, {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('✅ Query deleted successfully!');
                location.reload();
            } else {
                alert('❌ Error: ' + data.error);
            }
        })
        .catch(err => alert('❌ Error: ' + err));
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateTimeAgo();
    setInterval(updateTimeAgo, 30000);
});
</script>

<style>
.hover-shadow {
    transition: box-shadow 0.3s ease;
}

.hover-shadow:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.stats-box {
    transition: transform 0.2s ease;
}

.stats-box:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}
