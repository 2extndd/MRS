# 🚀 Быстрый старт: Настройка Query Delay и Blacklist

## ⚡ ГЛАВНОЕ: Railway Cron НЕ НУЖЕН!

Ваш scheduler **УЖЕ работает 24/7** внутри web процесса!

---

## 📋 Шаг 1: Настройка Query Delay (интервал сканирования)

### Откройте Web UI → `/config`

### Найдите "Query Delay (seconds) ⚡"

### Установите нужное значение:

| Интервал | Описание | Рекомендация |
|----------|----------|--------------|
| **30s** | Очень частое сканирование | ⚠️ Высокая нагрузка |
| **60s** | Сканирование каждую минуту | ✅ **Рекомендуется** |
| **120s** | Сканирование каждые 2 минуты | ✅ Хороший баланс |
| **180s** | Сканирование каждые 3 минуты | ✅ Экономия ресурсов |
| **300s** | Сканирование каждые 5 минут | ℹ️ По умолчанию |

### Нажмите **"Save System Settings"**

### ✅ Готово! Изменения применятся автоматически в течение 60 секунд

---

## 🔍 Шаг 2: Настройка Category Blacklist (фильтр категорий)

### Откройте Web UI → `/config`

### Найдите "Category Filter"

### Добавьте категории для фильтрации (одна на строку):

```
ゲーム・おもちゃ・グッズ
本・音楽・ゲーム
エンタメ・ホビー
ベビー・キッズ
コスメ・美容
```

### Нажмите **"Save Category Filter"**

### ✅ Готово! Вещи из этих категорий больше не будут сохраняться в БД

---

## 🗑️ Шаг 3: Удалите Railway Cron Job

### Почему нужно удалить:
- ❌ Не используется (scheduler работает внутри web процесса)
- ❌ Создаёт лишние HTTP запросы
- ❌ Ограничен 5 минутами (внутренний scheduler может быть 30 секунд!)

### Как удалить:
1. Откройте **Railway Dashboard**
2. Ваш проект → **Settings**
3. **Cron Jobs** → Удалите job
4. ✅ Готово!

---

## 🔍 Проверка работы

### 1. Проверьте Railway logs:
```
[AUTOSTART] ✅ Scheduler thread started in background
[SCHEDULER] ⏰ Entering main loop...
[SCHEDULER] Jobs scheduled: 4
[SCHEDULER] ⏰ Loop alive! Iteration 30 (0 min uptime)
```

### 2. Проверьте текущие настройки:
- Web UI → `/config`
- Проверьте "Query Delay (seconds)"
- Проверьте "Category Filter"

### 3. Проверьте активные поиски:
- Web UI → `/queries`
- Убедитесь что поиски активны

### 4. Проверьте логи сканирования:
- Web UI → `/logs`
- Ищите строки: `[SEARCH] Completed at ...`
- Ищите строки: `[FILTER] 🚫 Item rejected` (если фильтрация работает)

---

## 📊 Архитектура (для понимания)

```
┌─────────────────────────────────────────────────────┐
│         Railway Web Service (1 процесс)              │
│                                                      │
│  ┌────────────────────────────────────────────┐    │
│  │  start.sh → gunicorn → wsgi.py             │    │
│  │                                             │    │
│  │  ┌──────────────────┐  ┌─────────────────┐│    │
│  │  │  Flask Web UI    │  │   Scheduler     ││    │
│  │  │  (port 8080)     │  │   (background   ││    │
│  │  │                  │  │    thread)      ││    │
│  │  │  • Dashboard     │  │                 ││    │
│  │  │  • Config        │  │  ⏰ Loop:       ││    │
│  │  │  • Queries       │  │    every 60s    ││    │
│  │  │  • Items         │  │                 ││    │
│  │  │  • Logs          │  │  ✓ search_cycle ││    │
│  │  │                  │  │  ✓ telegram_cycle│   │
│  │  │                  │  │  ✓ hot_reload   ││    │
│  │  └──────────────────┘  └─────────────────┘│    │
│  └────────────────────────────────────────────┘    │
│                                                      │
│  Database (SQLite/PostgreSQL)                       │
│  ├─ config_search_interval = 60                     │
│  ├─ config_category_blacklist = [...]               │
│  └─ items, searches, logs                           │
└─────────────────────────────────────────────────────┘

❌ Railway Cron Job (НЕ ИСПОЛЬЗУЕТСЯ!)
   Минимум: 5 минут
   Статус: УДАЛИТЕ!
```

---

## 🎯 FAQ

### Q: Можно ли ставить Query Delay меньше 5 минут?
**A:** ✅ ДА! Можно ставить хоть 30 секунд. Railway cron ограничен 5 минутами, но внутренний scheduler работает с любым интервалом.

### Q: Нужно ли перезапускать приложение после изменения настроек?
**A:** ❌ НЕТ! Hot reload автоматически подхватывает изменения из БД каждые 60 секунд.

### Q: Как проверить что blacklist работает?
**A:** Откройте Web UI → `/logs` и ищите строки `[FILTER] 🚫 Item rejected: category '...' is blacklisted`

### Q: Что делать если scheduler не запускается?
**A:** Проверьте Railway logs. Должны быть строки `[AUTOSTART] ✅ Scheduler thread started`. Если их нет - проверьте что `RAILWAY_ENVIRONMENT` установлена в переменных окружения.

### Q: Можно ли использовать Railway Cron вместо внутреннего scheduler?
**A:** ❌ НЕТ! Railway cron минимум 5 минут, а внутренний scheduler может работать каждую минуту. Плюс внутренний scheduler уже работает 24/7.

---

## ✅ Чеклист настройки

- [ ] Открыл Web UI → `/config`
- [ ] Установил Query Delay: **60-120 секунд**
- [ ] Добавил категории в blacklist
- [ ] Сохранил настройки
- [ ] **Удалил Railway Cron Job**
- [ ] Проверил Railway logs (scheduler запущен)
- [ ] Проверил Web UI → `/logs` (сканирование работает)
- [ ] Проверил Web UI → `/items` (вещи добавляются)

---

## 🎉 Готово!

Теперь ваш бот:
- ✅ Сканирует с нужным интервалом (даже 30 секунд!)
- ✅ Фильтрует ненужные категории
- ✅ Работает 24/7 автоматически
- ✅ Применяет изменения настроек автоматически

**Наслаждайтесь!** 🚀
